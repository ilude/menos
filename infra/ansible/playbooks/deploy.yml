---
- name: Deploy menos stack
  hosts: menos
  become: true

  tasks:
    - name: Create deploy directory
      ansible.builtin.file:
        path: "{{ deploy_path }}"
        state: directory
        mode: "0755"

    - name: Create data directories
      ansible.builtin.file:
        path: "{{ data_path }}/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - surrealdb
        - minio
        - ollama
        - keys

    - name: Find ed25519 public keys
      ansible.builtin.find:
        paths: /mnt/ssh
        patterns: "*.pub"
      delegate_to: localhost
      become: false
      register: pub_keys

    - name: Read ed25519 public keys
      ansible.builtin.slurp:
        src: "{{ item.path }}"
      delegate_to: localhost
      become: false
      loop: "{{ pub_keys.files }}"
      register: key_contents
      when: pub_keys.files | length > 0

    - name: Deploy authorized_keys for API auth
      ansible.builtin.copy:
        content: |
          # Authorized keys for menos API authentication
          # Deployed by Ansible
          {% for key in key_contents.results %}
          {% if key.content is defined and (key.content | b64decode | trim).startswith('ssh-ed25519') %}
          {{ key.content | b64decode | trim }}
          {% endif %}
          {% endfor %}
        dest: "{{ data_path }}/keys/authorized_keys"
        mode: "0644"
      when: key_contents.results is defined

    - name: Set SurrealDB directory ownership
      ansible.builtin.file:
        path: "{{ data_path }}/surrealdb"
        owner: "65532"
        group: "65532"
        recurse: true

    # --- Pre-flight checks ---
    - name: Configure git for container environment
      ansible.builtin.shell: |
        git config --global --add safe.directory /project
        git config --global core.autocrlf input
      delegate_to: localhost
      changed_when: false

    - name: Get local git SHA
      ansible.builtin.command:
        cmd: git rev-parse HEAD
        chdir: /project
      delegate_to: localhost
      register: local_git_sha
      changed_when: false

    - name: Get local git branch
      ansible.builtin.command:
        cmd: git rev-parse --abbrev-ref HEAD
        chdir: /project
      delegate_to: localhost
      register: local_git_branch
      changed_when: false

    - name: Check for uncommitted changes
      ansible.builtin.command:
        cmd: git status --porcelain
        chdir: /project
      delegate_to: localhost
      register: git_status
      changed_when: false
      failed_when: git_status.stdout != ""

    - name: Display deploy info
      ansible.builtin.debug:
        msg: "Deploying {{ local_git_sha.stdout[:8] }} ({{ local_git_branch.stdout }}) to {{ ansible_host }}"

    # --- Version gate ---
    - name: Check if API is currently running
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:8000/health"
        return_content: true
      register: server_health
      failed_when: false
      changed_when: false

    - name: Check ancestry when server has a known SHA
      ansible.builtin.command:
        cmd: "git merge-base --is-ancestor {{ server_health.json.git_sha }} {{ local_git_sha.stdout }}"
        chdir: /project
      delegate_to: localhost
      register: ancestry_check
      changed_when: false
      failed_when: ancestry_check.rc != 0
      when:
        - server_health.status == 200
        - server_health.json.git_sha is defined
        - server_health.json.git_sha != "unknown"

    - name: Sync compose files
      ansible.builtin.copy:
        src: "../files/menos/"
        dest: "{{ deploy_path }}/"
        mode: "0644"

    - name: Create API directory
      ansible.builtin.file:
        path: "{{ deploy_path }}/api"
        state: directory
        mode: "0755"

    - name: Sync API menos directory
      ansible.builtin.shell: |
        rsync -av --delete \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          -e "ssh -o StrictHostKeyChecking=no" \
          /project/api/menos/ {{ ansible_user }}@{{ ansible_host }}:{{ deploy_path }}/api/menos/
      delegate_to: localhost
      register: rsync_result
      changed_when: rsync_result.stdout_lines | length > 4

    - name: Sync API migrations directory
      ansible.builtin.shell: |
        rsync -av --delete \
          -e "ssh -o StrictHostKeyChecking=no" \
          /project/api/migrations/ {{ ansible_user }}@{{ ansible_host }}:{{ deploy_path }}/api/migrations/
      delegate_to: localhost
      register: migrations_rsync_result
      changed_when: migrations_rsync_result.stdout_lines | length > 4

    - name: Sync API config files
      ansible.builtin.copy:
        src: "/project/api/{{ item }}"
        dest: "{{ deploy_path }}/api/"
        mode: "0644"
      loop:
        - pyproject.toml
        - Dockerfile

    - name: Copy .env file
      ansible.builtin.copy:
        src: "/project/.env"
        dest: "{{ deploy_path }}/.env"
        mode: "0600"

    - name: Pull container images
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ deploy_path }}"
      changed_when: true

    - name: Build API image
      ansible.builtin.command:
        cmd: "docker compose build --build-arg GIT_SHA={{ local_git_sha.stdout }} --build-arg BUILD_DATE={{ ansible_date_time.iso8601 }} menos-api"
        chdir: "{{ deploy_path }}"
      changed_when: true

    - name: Start services
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ deploy_path }}"
      changed_when: true

    - name: Wait for services to be healthy
      ansible.builtin.pause:
        seconds: 10

    - name: Show service status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ deploy_path }}"
      register: compose_status
      changed_when: false

    - name: Display status
      ansible.builtin.debug:
        var: compose_status.stdout_lines

    # --- Post-deploy verification ---
    - name: Verify deployed version
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:8000/health"
        return_content: true
      register: post_deploy_health
      retries: 5
      delay: 3
      until: post_deploy_health.status == 200
      changed_when: false

    - name: Confirm SHA matches
      ansible.builtin.assert:
        that:
          - post_deploy_health.json.git_sha == local_git_sha.stdout
        fail_msg: "Deploy verification failed! Expected {{ local_git_sha.stdout }}, got {{ post_deploy_health.json.git_sha }}"
        success_msg: "Deploy verified: {{ post_deploy_health.json.git_sha[:8] }} running on {{ ansible_host }}"

    - name: Pull Ollama models
      ansible.builtin.command:
        cmd: docker exec menos-ollama ollama pull {{ item }}
      loop:
        - mxbai-embed-large
        - qwen3:latest
      changed_when: true
